---
title: "03_DensityHabitat"
output: html_document
date: "2024-02-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse);library(MuMIn);library(rsq)

habitat <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/habitat_covs.csv") 
albi_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/albi_dat.csv")
allo_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/allocebus_dat.csv")
avahi_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/avahi_dat.csv")
cheiro_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/cheirogaleus_dat.csv")
hapa_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/hapa_dat.csv")
rubri_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/rubriventer_dat.csv")
prop_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/prop_dat.csv")
lepi_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/lepilemur_dat.csv")
micro_density <- read.csv("~/Documents/GitHub/COMATSA_GitHub/COMATSA_GitHub/Data/microcebus_dat.csv")

albi_density$Species <- "Eulemur_albifrons"
allo_density$Species <- "Allocebus_trichotis"
avahi_density$Species <- "Avahi_laniger"
cheiro_density$Species <- "Cheirogaleus_crossleyi"
hapa_density$Species <- "Hapalemur_occidentalis"
rubri_density$Species <- "Eulemur_rubriventer"
prop_density$Species <- "Propithecus_candidus"
lepi_density$Species <- "Lepilemur_saeli"
micro_density$Species <- "Microcebus_lehilahytsara"

lemur_densities <- rbind(albi_density, allo_density, avahi_density, cheiro_density, hapa_density, rubri_density, prop_density, lepi_density, micro_density) %>% dplyr::select(Site_Transect, Site, Transect, Density_km2, Species) %>% rename(SiteTransect = Site_Transect)

habitat2 <- habitat %>% dplyr::select(MEAN, cov, Species, SiteTransect) %>%pivot_wider(names_from = cov, values_from = MEAN)
habitat2$ForestLossProp <- habitat2$ForestLoss/habitat2$ForestCover

densities_habitat <- left_join(lemur_densities, habitat2, by=c("SiteTransect", "Species"))

```

```{r Lemur Density Heatmap}

lemur_densities2 <- lemur_densities
#lemur_densities2$Density_km2[lemur_densities2$Density_km2>700]<- NA

ggplot(data= lemur_densities2, aes(x=Species, y=SiteTransect, fill= sqrt(Density_km2)))+
  geom_tile()+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_viridis_c(direction = -1,option="magma")

```

```{r Lemur species dataframes}
densities_habitat_allo <- densities_habitat[densities_habitat$Species=="Allocebus_trichotis",]
densities_habitat_micro <- densities_habitat[densities_habitat$Species=="Microcebus_lehilahytsara",]
densities_habitat_avahi <- densities_habitat[densities_habitat$Species=="Avahi_laniger",]
densities_habitat_prop <- densities_habitat[densities_habitat$Species=="Propithecus_candidus",]
densities_habitat_cheiro <- densities_habitat[densities_habitat$Species=="Cheirogaleus_crossleyi",]
densities_habitat_lepi <- densities_habitat[densities_habitat$Species=="Lepilemur_saeli",]
densities_habitat_rubri <- densities_habitat[densities_habitat$Species=="Eulemur_rubriventer",]
densities_habitat_albi <- densities_habitat[densities_habitat$Species=="Eulemur_albifrons",]
densities_habitat_hapa <- densities_habitat[densities_habitat$Species=="Hapalemur_occidentalis",]

ggplot(data=densities_habitat_allo, aes(x=Density_km2))+geom_histogram()
shapiro.test(densities_habitat_allo$Density_km2)
shapiro.test(log(densities_habitat_allo$Density_km2+1))
shapiro.test(sqrt(densities_habitat_allo$Density_km2))

shapiro.test(densities_habitat_micro$Density_km2)
shapiro.test(log(densities_habitat_micro$Density_km2+1))
shapiro.test(sqrt(densities_habitat_micro$Density_km2))

shapiro.test(densities_habitat_avahi$Density_km2)
shapiro.test(log(densities_habitat_avahi$Density_km2+1))
shapiro.test(sqrt(densities_habitat_avahi$Density_km2))

shapiro.test(densities_habitat_prop$Density_km2)
shapiro.test(log(densities_habitat_prop$Density_km2+1))
shapiro.test(sqrt(densities_habitat_prop$Density_km2))

shapiro.test(densities_habitat_cheiro$Density_km2)
shapiro.test(log(densities_habitat_cheiro$Density_km2+1))
shapiro.test(sqrt(densities_habitat_cheiro$Density_km2))

shapiro.test(densities_habitat_lepi$Density_km2)
shapiro.test(log(densities_habitat_lepi$Density_km2+1))
shapiro.test(sqrt(densities_habitat_lepi$Density_km2))

shapiro.test(densities_habitat_rubri$Density_km2)
shapiro.test(log(densities_habitat_rubri$Density_km2+1))
shapiro.test(sqrt(densities_habitat_rubri$Density_km2))

shapiro.test(densities_habitat_albi$Density_km2)
shapiro.test(log(densities_habitat_albi$Density_km2+1))
shapiro.test(sqrt(densities_habitat_albi$Density_km2))

shapiro.test(densities_habitat_hapa$Density_km2)
shapiro.test(log(densities_habitat_hapa$Density_km2+1))
shapiro.test(sqrt(densities_habitat_hapa$Density_km2))

```

```{r Habitat Model: Allocebus}

densities_habitat_allo <- densities_habitat[densities_habitat$Species=="Allocebus_trichotis",]

allo_full <- lmer(data = densities_habitat_allo, sqrt(Density_km2) ~ Elevation + CanopyHeight + Ruggedness+ForestLossProp + (1|Site),na.action = "na.fail")
allo_dredge <- dredge(allo_full)
allo_model_avg <- model.avg(allo_dredge)
summary(allo_model_avg)

allo_coefficients <- as.data.frame(allo_model_avg$coefficients)[1,]
allo_coefficients <- allo_coefficients[, sort(colnames(allo_coefficients))]


```

```{r Habitat Model: Microcebus}

densities_habitat_micro <- densities_habitat[densities_habitat$Species=="Microcebus_lehilahytsara",]

micro_full <- lmer(data = densities_habitat_micro , sqrt(Density_km2) ~ Elevation + CanopyHeight + Ruggedness+ForestLossProp + (1|Site),na.action = "na.fail")
micro_dredge <- dredge(micro_full)
micro_model_avg <- model.avg(micro_dredge)
summary(micro_model_avg)

micro_coefficients <- as.data.frame(micro_model_avg$coefficients)[1,]
micro_coefficients <- micro_coefficients[, sort(colnames(micro_coefficients))]


```

```{r Habitat Model: Cheirogaleus}

densities_habitat_cheiro <- densities_habitat[densities_habitat$Species=="Cheirogaleus_crossleyi",]
densities_habitat_cheiro <- densities_habitat_cheiro %>% drop_na()

cheiro_full <- lmer(data = densities_habitat_cheiro , sqrt(Density_km2) ~ Elevation + CanopyHeight + Ruggedness +ForestLossProp+ (1|Site), na.action = "na.fail")
cheiro_dredge <- dredge(cheiro_full)
cheiro_model_avg <- model.avg(cheiro_dredge)
summary(cheiro_model_avg)

cheiro_coefficients <- as.data.frame(cheiro_model_avg$coefficients)[1,]
cheiro_coefficients <- cheiro_coefficients[, sort(colnames(cheiro_coefficients))]

```

```{r Habitat Model: Lepilemur}

densities_habitat_lepi <- densities_habitat[densities_habitat$Species=="Lepilemur_saeli",]

lepi_full <- lmer(data = densities_habitat_lepi , sqrt(Density_km2) ~ Elevation + CanopyHeight +Ruggedness +ForestLossProp+ (1|Site),na.action = "na.fail")
lepi_dredge <- dredge(lepi_full)
lepi_model_avg <- model.avg(lepi_dredge)
summary(lepi_model_avg)

lepi_coefficients <- as.data.frame(lepi_model_avg$coefficients)[1,]
lepi_coefficients <- lepi_coefficients[, sort(colnames(lepi_coefficients))]


```

```{r Habitat Model: Avahi}

densities_habitat_avahi <- densities_habitat[densities_habitat$Species=="Avahi_laniger",]

avahi_full <- lmer(data = densities_habitat_avahi , sqrt(Density_km2) ~ Elevation + CanopyHeight+ Ruggedness+ForestLossProp+ (1|Site),na.action = "na.fail")
avahi_dredge <- dredge(avahi_full)
avahi_model_avg <- model.avg(avahi_dredge)
summary(avahi_model_avg)

avahi_coefficients <- as.data.frame(avahi_model_avg$coefficients)[1,]
avahi_coefficients <- avahi_coefficients[, sort(colnames(avahi_coefficients))]


```

```{r Habitat Model: Propithecus}

densities_habitat_prop <- densities_habitat[densities_habitat$Species=="Propithecus_candidus",]

prop_full <- lmer(data = densities_habitat_prop , sqrt(Density_km2) ~Elevation + CanopyHeight+ Ruggedness+ForestLossProp+ (1|Site),na.action = "na.fail")
prop_dredge <- dredge(prop_full)
prop_model_avg <- model.avg(prop_dredge)
summary(prop_model_avg )

prop_coefficients <- as.data.frame(prop_model_avg$coefficients)[1,]
prop_coefficients <- prop_coefficients[, sort(colnames(prop_coefficients))]


```

```{r Habitat Model: ALbifrons}

densities_habitat_albi <- densities_habitat[densities_habitat$Species=="Eulemur_albifrons",]

albi_full <- lmer(data = densities_habitat_albi , sqrt(Density_km2) ~ Elevation + CanopyHeight + Ruggedness +ForestLossProp+ (1|Site),na.action = "na.fail")
albi_dredge <- dredge(albi_full, extra = "R^2")
albi_model_avg <- model.avg(albi_dredge)
summary_albi_model_avg <- summary(albi_model_avg)
summary_albi_model_avg

albi_coefficients <- as.data.frame(albi_model_avg$coefficients)[1,]
albi_coefficients <- albi_coefficients[, sort(colnames(albi_coefficients))]


```

```{r Habitat Model: Rubriventer}

densities_habitat_rubri <- densities_habitat[densities_habitat$Species=="Eulemur_rubriventer",]


rubri_full <- lmer(data = densities_habitat_rubri , sqrt(Density_km2) ~ Elevation + CanopyHeight + Ruggedness +ForestLossProp+ (1|Site),na.action = "na.fail")
rubri_dredge <- dredge(rubri_full)
rubri_model_avg <- model.avg(rubri_dredge)
summary(rubri_model_avg)

rubri_coefficients <- as.data.frame(rubri_model_avg$coefficients)[1,]
rubri_coefficients <- rubri_coefficients[, sort(colnames(rubri_coefficients))]


```

```{r Habitat Model: Hapalemur}

densities_habitat_hapa <- densities_habitat[densities_habitat$Species=="Hapalemur_occidentalis",]

hapa_full <- lmer(data = densities_habitat_hapa , sqrt(Density_km2) ~ Elevation + CanopyHeight + Ruggedness + ForestLossProp+(1|Site), na.action = "na.fail")
hapa_dredge <- dredge(hapa_full)
hapa_model_avg <- model.avg(hapa_dredge)
summary(hapa_model_avg)

hapa_coefficients <- as.data.frame(hapa_model_avg$coefficients)[1,]
hapa_coefficients <- hapa_coefficients[, sort(colnames(hapa_coefficients))]


```
# Exclude everything over 1800m in predictions
# Make NA and not zero, but it's functionally zero (we can discussion)
# Log transform the lemur densities

